var M=Object.create;var g=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var q=t=>g(t,"__esModule",{value:!0});var L=(t,e,o,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of R(e))!W.call(t,s)&&(o||s!=="default")&&g(t,s,{get:()=>e[s],enumerable:!(r=N(e,s))||r.enumerable});return t},i=(t,e)=>L(q(g(t!=null?M(T(t)):{},"default",!e&&t&&t.__esModule?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var w=i(require("fs")),d=i(require("path"));var v=i(require("fs")),n=i(require("path")),A=i(require("events")),C=i(require("countapi-js"));var u=class{space=0;prefix="";constructor(e=0){this.space=e,this.prefix=" ".repeat(e)}next(){return new u(this.space+2)}log(...e){console.log(this.prefix,"[94m[LOG][m",...e)}error(...e){console.log(this.prefix,"[91m[ERROR][m",...e)}warn(...e){console.log(this.prefix,"[93m[WARN][m",...e)}info(...e){console.log(this.prefix,"[96m[INFO][m",...e)}debug(...e){console.log(this.prefix,"[95m[DEBUG][m",...e)}},p=u;var b=i(require("events")),y=i(require("playwright")),j=["chromium","firefox","webkit"],D={headless:!0,firefoxUserPrefs:{"dom.webaudio.enabled":!1,"media.volume_scale":0}},x=class extends b.default{constructor(e,o,r=null){super();this.browser_type=e;this.browser_config=o;this.logger=r;j.includes(e)||(e="firefox"),this.setup()}browser=null;context=null;user_agent="";info(...e){this.logger&&this.logger.info(...e)}async setup(){}async launch(){if(!this.browser){this.info("\u4F7F\u7528\u700F\u89BD\u5668",this.browser_type);let e=y.default[this.browser_type];this.browser=await e.launch({...D,...this.browser_config}),this.emit("launched",this.browser)}if(!this.context){let e=await this.browser.newPage();this.user_agent=(await e.evaluate(()=>navigator.userAgent)).replace("Headless","")+" BA/1",await e.close(),this.info("User-Agent:",this.user_agent),this.context=await this.browser.newContext({userAgent:this.user_agent}),this.emit("context_created",this.context)}return this}async close(){return this.browser&&(await this.browser.close(),this.browser=null,this.context=null,this.user_agent="",this.emit("closed")),this}async new_page(){if(!this.context)throw new Error("No Context.");let e=await this.context.newPage();return this.emit("new_page",e),e}},f=x;async function B(t){new Promise(e=>setTimeout(e,t))}process.env.TZ="Asia/Taipei";var I=J();function J(){try{let t=5,e=n.default.resolve(__dirname,"package.json");for(;!v.default.existsSync(e)&&t-- >0;)e=n.default.resolve(n.default.dirname(e),"..","package.json");return require(e).version}catch{return""}}var E=class extends A.default{modules;params;browser_config;logger=new p;start_time=null;end_time=null;browser;constructor({modules:e=[],params:o={},browser:r={}}){super();this.browser_config=r,this.modules=e,this.params=o,this.setup()}setup(){let e=this;this.on("start",()=>{e.log("\u958B\u59CB\u57F7\u884C\u5DF4\u54C8\u59C6\u7279\u81EA\u52D5\u5316 "+I),C.default.update("Bahamut-Automation","run",1)}),this.on("module_start",(o,r)=>{e.log(`\u57F7\u884C ${o} \u6A21\u7D44 (${r})`)}),this.on("module_loaded",(o,r)=>{e.log(`\u53C3\u6578: ${r.parameters.map(({name:s,required:a})=>` ${s}${a?"*":""}`).join(" ")||"\u7121"}`)}),this.on("module_finished",o=>{e.log(`\u6A21\u7D44 ${o} \u57F7\u884C\u5B8C\u7562
`)}),this.on("module_failed",(o,r)=>{e.logger.error(`\u6A21\u7D44 ${o} \u57F7\u884C\u5931\u6557
`),e.logger.error(r)}),this.on("finished",(o,r)=>{e.log("\u5DF4\u54C8\u59C6\u7279\u81EA\u52D5\u5316\u57F7\u884C\u5B8C\u7562"),e.log(`\u57F7\u884C\u6642\u9593: ${U(r)}`),e.log("\u8F38\u51FA:",o)}),this.on("fatal",o=>{e.logger.error("\u5DF4\u54C8\u59C6\u7279\u81EA\u52D5\u5316\u57F7\u884C\u5931\u6557"),e.logger.error(o),e.browser&&e.browser.close()})}async run(){try{this.start_time=Date.now(),this.emit("start"),this.browser=new f(this.browser_config.type||"firefox",this.browser_config,this.logger),await this.browser.launch(),this.emit("browser_opened");let e={};for(let r of this.modules){try{let s=n.default.isAbsolute(r),a=n.default.resolve(__dirname,"../modules",r);r=n.default.basename(r),this.emit("module_start",r,s?a:"Built-in");let h=require(a).default||require(a);this.emit("module_loaded",r,h);let c=await this.browser.new_page(),_={};for(let{name:l,required:k}of h.parameters)if(this.params[l]!==void 0)_[l]=this.params[l];else if(k)throw await c.close(),this.emit("module_parameter_error",r,l),new Error(`\u6A21\u7D44 ${r} \u6240\u5FC5\u9808\u4E4B ${l} \u53C3\u6578\u4E0D\u5B58\u5728`);e[r]=await h.run({page:c,outputs:e,params:_,logger:this.logger.next()}),await c.close(),this.emit("module_finished",r)}catch(s){this.emit("module_failed",r,s)}await B(1e3)}await this.browser.close(),this.end_time=Date.now();let o=Math.floor((this.end_time-this.start_time)/1e3);return this.emit("finished",JSON.parse(JSON.stringify(e)),o),{outputs:JSON.parse(JSON.stringify(e)),time:o}}catch(e){return this.emit("fatal",e),null}}log(...e){this.logger.log(...e),this.emit("log",...e)}};function U(t){let e=Math.floor(t/3600),o=Math.floor((t-e*3600)/60),r=t-e*3600-o*60;return`${e} \u5C0F\u6642 ${o} \u5206 ${r} \u79D2`}var P=E;var $=P;var F=require("readline").createInterface({input:process.stdin,output:process.stdout});G();async function G(){let t=H();(t.help||t.h)&&(V(),process.exit(0));let e=(t.mode?+t.mode[0]:null)||(t.m?+t.m[0]:null);if(e!==1&&e!==2)for(;e=+(await O(["\u9078\u64C7\u6A21\u5F0F: ","1. \u8A2D\u5B9A\u6A94\u57F7\u884C","2. \u76F4\u63A5\u57F7\u884C",">> "].join(`
`))).trim(),!(e===1||e===2););if(e===1){let o=(t.config?t.config[0]:null)||(t.c?t.c[0]:null);if(o=S(o),o&&(o=d.default.resolve(process.cwd(),o)),!w.default.existsSync(o))for(;o=d.default.resolve(process.cwd(),S((await O("\u8ACB\u8F38\u5165\u8A2D\u5B9A\u6A94\u4F4D\u7F6E: ")).trim())),!w.default.existsSync(o);)console.log("\u8A2D\u5B9A\u6A94\u4E0D\u5B58\u5728:",o);let r=require(o);await new $(r).run()}else e===2&&console.log("\u62B1\u6B49\uFF0C\u6211\u9084\u6C92\u5BE6\u4F5C\u9019\u500B\u529F\u80FD\u3002 :(");console.log("\u7A0B\u5F0F\u57F7\u884C\u5B8C\u7562"),process.exit(0)}function O(t=""){return new Promise(e=>F.question(t,e))}function H(){let t=process.argv.slice(2),e={},o=null;for(let r=0;r<t.length;r++){let s=t[r];s.startsWith("--")?(o=s.slice(2),e[o]||(e[o]=[])):s.startsWith("-")?(o=s.slice(1),e[o]||(e[o]=[])):o&&e[o].push(s.trim())}return e}function S(t){return t&&(t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'"))?t.substring(1,t.length-1):t}function V(){console.log("\u53C3\u6578: [--mode=1|2] [--config=path] [--help]"),console.log("  --mode (-m): \u8A2D\u5B9A\u6A94\u57F7\u884C\u6A21\u5F0F"),console.log("  --config (-c): \u8A2D\u5B9A\u6A94\u4F4D\u7F6E"),console.log("  --help (-h): \u986F\u793A\u6B64\u8AAA\u660E")}
