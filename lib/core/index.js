var O=Object.create;var l=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,S=Object.prototype.hasOwnProperty;var _=t=>l(t,"__esModule",{value:!0});var T=(t,e)=>{for(var r in e)l(t,r,{get:e[r],enumerable:!0})},b=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of N(e))!S.call(t,s)&&(r||s!=="default")&&l(t,s,{get:()=>e[s],enumerable:!(o=M(e,s))||o.enumerable});return t},n=(t,e)=>b(_(l(t!=null?O(R(t)):{},"default",!e&&t&&t.__esModule?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t),L=(t=>(e,r)=>t&&t.get(e)||(r=b(_({}),e,1),t&&t.set(e,r),r))(typeof WeakMap!="undefined"?new WeakMap:0);var F={};T(F,{BahamutAutomation:()=>w,Browser:()=>p,Logger:()=>g,default:()=>j});var C=n(require("fs")),i=n(require("path")),E=n(require("events")),A=n(require("countapi-js"));var h=class{space=0;prefix="";constructor(e=0){this.space=e,this.prefix=" ".repeat(e)}next(){return new h(this.space+2)}log(...e){console.log(this.prefix,"[94m[LOG][m",...e)}error(...e){console.log(this.prefix,"[91m[ERROR][m",...e)}warn(...e){console.log(this.prefix,"[93m[WARN][m",...e)}info(...e){console.log(this.prefix,"[96m[INFO][m",...e)}debug(...e){console.log(this.prefix,"[95m[DEBUG][m",...e)}},g=h;var y=n(require("events")),x=n(require("playwright")),k=["chromium","firefox","webkit"],q={headless:!0,firefoxUserPrefs:{"dom.webaudio.enabled":!1,"media.volume_scale":0}},B=class extends y.default{constructor(e,r,o=null){super();this.browser_type=e;this.browser_config=r;this.logger=o;k.includes(e)||(e="firefox"),this.setup()}browser=null;context=null;user_agent="";info(...e){this.logger&&this.logger.info(...e)}async setup(){}async launch(){if(!this.browser){this.info("\u4F7F\u7528\u700F\u89BD\u5668",this.browser_type);let e=x.default[this.browser_type];this.browser=await e.launch({...q,...this.browser_config}),this.emit("launched",this.browser)}if(!this.context){let e=await this.browser.newPage();this.user_agent=(await e.evaluate(()=>navigator.userAgent)).replace("Headless","")+" BA/1",await e.close(),this.info("User-Agent:",this.user_agent),this.context=await this.browser.newContext({userAgent:this.user_agent}),this.emit("context_created",this.context)}return this}async close(){return this.browser&&(await this.browser.close(),this.browser=null,this.context=null,this.user_agent="",this.emit("closed")),this}async new_page(){if(!this.context)throw new Error("No Context.");let e=await this.context.newPage();return this.emit("new_page",e),e}},p=B;async function v(t){new Promise(e=>setTimeout(e,t))}process.env.TZ="Asia/Taipei";var D=J();function J(){try{let t=5,e=i.default.resolve(__dirname,"package.json");for(;!C.default.existsSync(e)&&t-- >0;)e=i.default.resolve(i.default.dirname(e),"..","package.json");return require(e).version}catch{return""}}var $=class extends E.default{modules;params;browser_config;logger=new g;start_time=null;end_time=null;browser;constructor({modules:e=[],params:r={},browser:o={}}){super();this.browser_config=o,this.modules=e,this.params=r,this.setup()}setup(){let e=this;this.on("start",()=>{e.log("\u958B\u59CB\u57F7\u884C\u5DF4\u54C8\u59C6\u7279\u81EA\u52D5\u5316 "+D),A.default.update("Bahamut-Automation","run",1)}),this.on("module_start",(r,o)=>{e.log(`\u57F7\u884C ${r} \u6A21\u7D44 (${o})`)}),this.on("module_loaded",(r,o)=>{e.log(`\u53C3\u6578: ${o.parameters.map(({name:s,required:a})=>` ${s}${a?"*":""}`).join(" ")||"\u7121"}`)}),this.on("module_finished",r=>{e.log(`\u6A21\u7D44 ${r} \u57F7\u884C\u5B8C\u7562
`)}),this.on("module_failed",(r,o)=>{e.logger.error(`\u6A21\u7D44 ${r} \u57F7\u884C\u5931\u6557
`),e.logger.error(o)}),this.on("finished",(r,o)=>{e.log("\u5DF4\u54C8\u59C6\u7279\u81EA\u52D5\u5316\u57F7\u884C\u5B8C\u7562"),e.log(`\u57F7\u884C\u6642\u9593: ${U(o)}`),e.log("\u8F38\u51FA:",r)}),this.on("fatal",r=>{e.logger.error("\u5DF4\u54C8\u59C6\u7279\u81EA\u52D5\u5316\u57F7\u884C\u5931\u6557"),e.logger.error(r),e.browser&&e.browser.close()})}async run(){try{this.start_time=Date.now(),this.emit("start"),this.browser=new p(this.browser_config.type||"firefox",this.browser_config,this.logger),await this.browser.launch(),this.emit("browser_opened");let e={};for(let o of this.modules){try{let s=i.default.isAbsolute(o),a=i.default.resolve(__dirname,"../modules",o);o=i.default.basename(o),this.emit("module_start",o,s?a:"Built-in");let f=require(a).default||require(a);this.emit("module_loaded",o,f);let c=await this.browser.new_page(),d={};for(let{name:m,required:P}of f.parameters)if(this.params[m]!==void 0)d[m]=this.params[m];else if(P)throw await c.close(),this.emit("module_parameter_error",o,m),new Error(`\u6A21\u7D44 ${o} \u6240\u5FC5\u9808\u4E4B ${m} \u53C3\u6578\u4E0D\u5B58\u5728`);e[o]=await f.run({page:c,outputs:e,params:d,logger:this.logger.next()}),await c.close(),this.emit("module_finished",o)}catch(s){this.emit("module_failed",o,s)}await v(1e3)}await this.browser.close(),this.end_time=Date.now();let r=Math.floor((this.end_time-this.start_time)/1e3);return this.emit("finished",JSON.parse(JSON.stringify(e)),r),{outputs:JSON.parse(JSON.stringify(e)),time:r}}catch(e){return this.emit("fatal",e),null}}log(...e){this.logger.log(...e),this.emit("log",...e)}};function U(t){let e=Math.floor(t/3600),r=Math.floor((t-e*3600)/60),o=t-e*3600-r*60;return`${e} \u5C0F\u6642 ${r} \u5206 ${o} \u79D2`}var w=$;var j=w;module.exports=L(F);0&&(module.exports={BahamutAutomation,Browser,Logger});
