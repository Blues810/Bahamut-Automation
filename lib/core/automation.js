/* minified */
"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),process.env.TZ="Asia/Taipei";const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),events_1=__importDefault(require("events")),countapi_js_1=__importDefault(require("countapi-js")),logger_1=__importDefault(require("./logger")),browser_1=__importDefault(require("./browser")),utils_1=require("./utils"),VERSION=get_version();function get_version(){try{let e=5,t=path_1.default.resolve(__dirname,"package.json");for(;!fs_1.default.existsSync(t)&&0<e--;)t=path_1.default.resolve(path_1.default.dirname(t),"..","package.json");return require(t).version}catch(e){return""}}class BahamutAutomation extends events_1.default{modules;params;browser_config;logger=new logger_1.default;start_time=null;end_time=null;browser;constructor({modules:e=[],params:t={},browser:r={}}){super(),this.browser_config=r,this.modules=e,this.params=t,this.setup()}setup(){const r=this;this.on("start",()=>{r.log("開始執行巴哈姆特自動化 "+VERSION),countapi_js_1.default.update("Bahamut-Automation","run",1)}),this.on("module_start",(e,t)=>{r.log(`執行 ${e} 模組 (${t})`)}),this.on("module_loaded",(e,t)=>{r.log("參數: "+(t.parameters.map(({name:e,required:t})=>" "+e+(t?"*":"")).join(" ")||"無"))}),this.on("module_finished",e=>{r.log(`模組 ${e} 執行完畢
`)}),this.on("module_failed",(e,t)=>{r.logger.error(`模組 ${e} 執行失敗
`),r.logger.error(t)}),this.on("finished",(e,t)=>{r.log("巴哈姆特自動化執行完畢"),r.log("執行時間: "+second_to_time(t)),r.log("輸出:",e)}),this.on("fatal",e=>{r.logger.error("巴哈姆特自動化執行失敗"),r.logger.error(e),r.browser&&r.browser.close()})}async run(){try{this.start_time=Date.now(),this.emit("start"),this.browser=new browser_1.default(this.browser_config.type||"firefox",this.browser_config,this.logger),await this.browser.launch(),this.emit("browser_opened");const i={};for(var t of this.modules){try{var e,r,o=path_1.default.resolve(__dirname,"../modules",t);path_1.default.isAbsolute(t)&&(t=path_1.default.basename(t)),this.emit("module_start",t,o);const a=require(o).default||require(o);this.emit("module_loaded",t,a);const l=await this.browser.new_page(),u={};for({name:e,required:r}of a.parameters)if(void 0!==this.params[e])u[e]=this.params[e];else if(r)throw await l.close(),this.emit("module_parameter_error",t,e),new Error(`模組 ${t} 所必須之 ${e} 參數不存在`);i[t]=await a.run({page:l,outputs:i,params:u,logger:this.logger.next()}),await l.close(),this.emit("module_finished",t)}catch(e){this.emit("module_failed",t,e)}await(0,utils_1.sleep)(1e3)}await this.browser.close(),this.end_time=Date.now();var s=Math.floor((this.end_time-this.start_time)/1e3);return this.emit("finished",JSON.parse(JSON.stringify(i)),s),{outputs:JSON.parse(JSON.stringify(i)),time:s}}catch(e){return this.emit("fatal",e),null}}log(...e){this.logger.log(...e),this.emit("log",...e)}}function second_to_time(e){var t=Math.floor(e/3600),r=Math.floor((e-3600*t)/60);return t+` 小時 ${r} 分 ${e-3600*t-60*r} 秒`}exports.default=BahamutAutomation;