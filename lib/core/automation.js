var O=Object.create;var u=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,S=Object.prototype.hasOwnProperty;var w=t=>u(t,"__esModule",{value:!0});var T=(t,e)=>{for(var r in e)u(t,r,{get:e[r],enumerable:!0})},d=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of N(e))!S.call(t,s)&&(r||s!=="default")&&u(t,s,{get:()=>e[s],enumerable:!(o=P(e,s))||o.enumerable});return t},n=(t,e)=>d(w(u(t!=null?O(R(t)):{},"default",!e&&t&&t.__esModule?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t),M=(t=>(e,r)=>t&&t.get(e)||(r=d(w({}),e,1),t&&t.set(e,r),r))(typeof WeakMap!="undefined"?new WeakMap:0);var U={};T(U,{BahamutAutomation:()=>c,default:()=>J});var E=n(require("events")),$=n(require("fs")),i=n(require("path")),A=n(require("countapi-js"));var _=n(require("events")),b=n(require("playwright")),k=["chromium","firefox","webkit"],L={headless:!0,firefoxUserPrefs:{"dom.webaudio.enabled":!1,"media.volume_scale":0}},y=class extends _.default{constructor(e,r,o=null){super();this.browser_type=e;this.browser_config=r;this.logger=o;k.includes(e)||(e="firefox"),this.setup()}browser=null;context=null;user_agent="";info(...e){this.logger&&this.logger.info(...e)}async setup(){}async launch(){if(!this.browser){this.info("\u4F7F\u7528\u700F\u89BD\u5668",this.browser_type);let e=b.default[this.browser_type];this.browser=await e.launch({...L,...this.browser_config}),this.emit("launched",this.browser)}if(!this.context){let e=await this.browser.newPage();this.user_agent=(await e.evaluate(()=>navigator.userAgent)).replace("Headless","")+" BA/1",await e.close(),this.info("User-Agent:",this.user_agent),this.context=await this.browser.newContext({userAgent:this.user_agent}),this.emit("context_created",this.context)}return this}async close(){return this.browser&&(await this.browser.close(),this.browser=null,this.context=null,this.user_agent="",this.emit("closed")),this}async new_page(){if(!this.context)throw new Error("No Context.");let e=await this.context.newPage();return this.emit("new_page",e),e}},x=y;var m=class{space=0;prefix="";constructor(e=0){this.space=e,this.prefix=" ".repeat(e)}next(){return new m(this.space+2)}log(...e){console.log(this.prefix,"\x1B[94m[LOG]\x1B[m",...e)}error(...e){console.log(this.prefix,"\x1B[91m[ERROR]\x1B[m",...e)}warn(...e){console.log(this.prefix,"\x1B[93m[WARN]\x1B[m",...e)}info(...e){console.log(this.prefix,"\x1B[96m[INFO]\x1B[m",...e)}debug(...e){console.log(this.prefix,"\x1B[95m[DEBUG]\x1B[m",...e)}},v=m;async function B(t){new Promise(e=>setTimeout(e,t))}process.env.TZ="Asia/Taipei";var q=(()=>{try{let t=5,e=i.default.resolve(__dirname,"package.json");for(;!$.default.existsSync(e)&&t-- >0;)e=i.default.resolve(i.default.dirname(e),"..","package.json");return require(e).version}catch{return""}})(),c=class extends E.default{modules;params;browser_config;logger=new v;start_time=null;end_time=null;browser;constructor({modules:e=[],params:r={},browser:o={}}){super();this.browser_config=o,this.modules=e,this.modules.includes("utils")||this.modules.unshift("utils"),this.params=r,this.setup()}setup(){let e=this;this.on("start",()=>{e.log("\u958B\u59CB\u57F7\u884C\u5DF4\u54C8\u59C6\u7279\u81EA\u52D5\u5316 "+q),A.default.update("Bahamut-Automation","run",1)}),this.on("module_start",(r,o)=>{e.log(`\u57F7\u884C ${r} \u6A21\u7D44 (${o})`)}),this.on("module_loaded",(r,o)=>{e.log(`\u53C3\u6578: ${o.parameters.map(({name:s,required:a})=>` ${s}${a?"*":""}`).join(" ")||"\u7121"}`)}),this.on("module_finished",r=>{e.log(`\u6A21\u7D44 ${r} \u57F7\u884C\u5B8C\u7562
`)}),this.on("module_failed",(r,o)=>{e.logger.error(`\u6A21\u7D44 ${r} \u57F7\u884C\u5931\u6557
`),e.logger.error(o)}),this.on("finished",(r,o)=>{e.log("\u5DF4\u54C8\u59C6\u7279\u81EA\u52D5\u5316\u57F7\u884C\u5B8C\u7562"),e.log(`\u57F7\u884C\u6642\u9593: ${D(o)}`),e.log("\u8F38\u51FA:",r)}),this.on("fatal",r=>{e.logger.error("\u5DF4\u54C8\u59C6\u7279\u81EA\u52D5\u5316\u57F7\u884C\u5931\u6557"),e.logger.error(r),e.browser&&e.browser.close()})}async run(){try{this.start_time=Date.now(),this.emit("start"),this.browser=new x(this.browser_config.type||"firefox",this.browser_config,this.logger),await this.browser.launch(),this.emit("browser_opened");let e={};for(let o of this.modules){try{let s=i.default.isAbsolute(o),a=i.default.resolve(__dirname,"../modules",o);o=i.default.basename(o),this.emit("module_start",o,s?a:"Built-in");let h=require(a).default||require(a);this.emit("module_loaded",o,h);let g=await this.browser.new_page(),f={};for(let{name:l,required:C}of h.parameters)if(this.params[l]!==void 0)f[l]=this.params[l];else if(C)throw await g.close(),this.emit("module_parameter_error",o,l),new Error(`\u6A21\u7D44 ${o} \u6240\u5FC5\u9808\u4E4B ${l} \u53C3\u6578\u4E0D\u5B58\u5728`);e[o]=await h.run({page:g,outputs:e,params:f,logger:this.logger.next()}),await g.close(),this.emit("module_finished",o)}catch(s){this.emit("module_failed",o,s)}await B(1e3)}await this.browser.close(),this.end_time=Date.now();let r=Math.floor((this.end_time-this.start_time)/1e3);return this.emit("finished",JSON.parse(JSON.stringify(e)),r),{outputs:JSON.parse(JSON.stringify(e)),time:r}}catch(e){return this.emit("fatal",e),null}}log(...e){this.logger.log(...e),this.emit("log",...e)}};function D(t){let e=Math.floor(t/3600),r=Math.floor((t-e*3600)/60),o=t-e*3600-r*60;return`${e} \u5C0F\u6642 ${r} \u5206 ${o} \u79D2`}var J=c;module.exports=M(U);0&&(module.exports={BahamutAutomation});
