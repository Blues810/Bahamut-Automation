/* minified */
const countapi=require("countapi-js");exports.parameters=[{name:"lottery_plus_max_attempts",required:!1},{name:"lottery_plus_max_parallel",required:!1}];class Pool{constructor(t){this.size=t,this.available=t,this.tasks=[],this.resolves=[],this.results=[]}push(t){this.tasks.push(async()=>t())}async go(){const t=[];for(let a=0;a<this.tasks.length;a++)await this.isAvailable(),t.push(this.tasks[a]().then(t=>{this.results[a]=t,0<this.resolves.length&&this.resolves.shift()()}));return await Promise.all(t),this.results}isAvailable(){return new Promise(t=>{0<this.available?(this.available--,t(!0)):this.resolves.push(t)})}}async function getList({page:t,error:a}){let e,i=3;for(;0<i--;){e=[];try{await t.goto("https://fuli.gamer.com.tw/shop.php?page=1");let a=await t.$$("a.items-card");for(let t=a.length-1;0<=t;t--)await a[t].evaluate(t=>t.innerHTML.includes("抽抽樂"))&&e.push({name:await a[t].evaluate(t=>t.querySelector(".items-title").innerHTML),link:await a[t].evaluate(t=>t.href)});for(;await t.$eval("a.pagenow",t=>!!t.nextSibling);){await t.goto("https://fuli.gamer.com.tw/shop.php?page="+await t.$eval("a.pagenow",t=>t.nextSibling.innerText));let a=await t.$$("a.items-card");for(let t=a.length-1;0<=t;t--)await a[t].evaluate(t=>t.innerHTML.includes("抽抽樂"))&&e.push({name:await a[t].evaluate(t=>t.querySelector(".items-title").innerHTML),link:await a[t].evaluate(t=>t.href)})}break}catch(t){a(t)}}return e}async function checkInfo({page:t,log:a,error:e}){try{var i=await t.$eval("#name",t=>t.value),r=await t.$eval("#tel",t=>t.value),o=await t.$eval("[name=city]",t=>t.value),n=await t.$eval("[name=country]",t=>t.value),l=await t.$eval("#address",t=>t.value);if(i||a("無收件人姓名"),r||a("無收件人電話"),o||a("無收件人城市"),n||a("無收件人區域"),l||a("無收件人地址"),!(i&&r&&o&&n&&l))throw new Error("警告：收件人資料不全")}catch(t){e(t)}}async function confirm({page:a,error:e}){try{await a.click("#agree-confirm"),await a.waitForSelector("#buyD > div.pbox-btn > a"),await a.waitForTimeout(100),await a.click("#buyD > div.pbox-btn > a"),await a.waitForSelector("#dialogify_1 > form > div > div > div.btn-box.text-right > button.btn.btn-insert.btn-primary"),await a.waitForTimeout(100),await Promise.all([a.waitForNavigation(),a.click("#dialogify_1 > form > div > div > div.btn-box.text-right > button.btn.btn-insert.btn-primary")]),await a.waitForTimeout(1e3)}catch(t){e(a.url()),e(t)}}function report({lottery:t,unfinished:a}){let e="# 福利社抽抽樂 \n\n";return t&&(e+=`✨✨✨ 獲得 **${t}** 個抽獎機會，價值 **${(500*t).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}** 巴幣 ✨✨✨
`),0===Object.keys(a).length&&(e+="🟢 所有抽獎皆已完成\n"),Object.keys(a).forEach(t=>{void 0!==a[t]&&(e+=`❌ 未能自動完成所有 ***[${t}](${a[t]})*** 的抽獎
`)}),e+="\n",e}exports.run=async({page:t,outputs:c,params:a,logger:e})=>{const w=(...t)=>e.log("[95m[Lottery+][m",...t),u=(...t)=>e.error("[95m[Lottery+][m",...t);if(!c.login||!c.login.success)throw new Error("使用者未登入，無法抽獎");if(!c.ad_handler)throw new Error("需使用 ad_handler 模組");w("開始執行");let h=0;w("正在尋找抽抽樂");const m=await getList({page:t,error:u});w(`找到 ${m.length} 個抽抽樂`);const p={};m.forEach(({name:t,link:a},e)=>{w(e+1+": "+t),p[t]=a});var i=+a.lottery_plus_max_parallel||3;const d=+a.lottery_plus_max_attempts||30,g=t.context(),r=new Pool(i);for(let t=0;t<m.length;t++)r.push(async()=>{var e,i=t,{link:r,name:o}=m[i];const n=await g.newPage();for(let a=1;a<=d;a++)try{if(await n.goto(r),await n.waitForSelector("#BH-master > .BH-lbox.fuli-pbox h1"),await n.waitForTimeout(100),await n.$(".btn-base.c-accent-o.is-disable")){w(o+" 的廣告免費次數已用完 [92m✔[m"),delete p[o];break}w(`[${i+1} / ${m.length}] (${a}) `+o),await n.click(".btn-base.c-accent-o").catch(u),await n.waitForTimeout(3e3),await n.$eval(".dialogify",t=>t.innerText.includes("勇者問答考驗")).catch(()=>{})&&(w("需要回答問題，正在回答問題"),await n.$$eval("#dialogify_1 .dialogify__body a",t=>{t.forEach(t=>{t.dataset.option==t.dataset.answer&&t.click()})}),await n.waitForSelector("#btn-buy"),await n.waitForTimeout(100),await n.click("#btn-buy")),await n.waitForTimeout(5e3);let t=await n.$eval(".dialogify .dialogify__body p",t=>t.innerText).catch(()=>{})||"";if(t.includes("廣告能量補充中")){await u("廣告能量補充中"),await n.reload().catch(u);continue}if(t.includes("觀看廣告")){w("正在觀看廣告"),await n.click("button[type=submit].btn.btn-insert.btn-primary").catch(u),await n.waitForSelector("ins iframe").catch(u),await n.waitForTimeout(1e3);const s=await n.$("ins iframe").catch(u);try{e=await s.contentFrame(),await c.ad_handler({ad_frame:e})}catch(t){u(t)}await n.waitForTimeout(1e3)}else w(t);const l=n.url();l.includes("/buyD.php")&&l.includes("ad=1")?(w("正在確認結算頁面"),await checkInfo({page:n,log:w,error:u}).catch(u),await confirm({page:n,error:u}).catch(u),await n.$(".card > .section > p")&&await n.$eval(".card > .section > p",t=>t.innerText.includes("成功"))?(w("已完成一次抽抽樂："+o+" [92m✔[m"),h++):w("發生錯誤，重試中 ✘")):(w(l),w("未進入結算頁面，重試中 ✘"),u("抽抽樂未進入結算頁面"))}catch(t){}});return await r.go(),await t.waitForTimeout(2e3),w("執行完畢 ✨"),h&&countapi.update("Bahamut-Automation","lottery",h),{lottery:h,unfinished:p,report:report}};