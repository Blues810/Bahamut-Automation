var u=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var $=e=>u(e,"__esModule",{value:!0});var I=(e,t)=>{for(var r in t)u(e,r,{get:t[r],enumerable:!0})},_=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of x(t))!P.call(e,i)&&(r||i!=="default")&&u(e,i,{get:()=>t[i],enumerable:!(o=y(t,i))||o.enumerable});return e};var T=(e=>(t,r)=>e&&e.get(t)||(r=_($({}),t,1),e&&e.set(t,r),r))(typeof WeakMap!="undefined"?new WeakMap:0);var k={};I(k,{default:()=>E});var h=class{parameters=[];run({page:t,outputs:r,params:o,logger:i}){throw new Error("Module not implemented.")}},w=h;var d=new w;d.parameters=[{name:"del_mail_match",required:!0}];d.run=async({page:e,outputs:t,params:r,logger:o})=>{let i=(...a)=>o.log("[95m[\u7AD9\u5167\u4FE1\u6E05\u9664][m",...a),m=(...a)=>o.warn("[95m[\u7AD9\u5167\u4FE1\u6E05\u9664][m",...a),s=(...a)=>o.error("[95m[\u7AD9\u5167\u4FE1\u6E05\u9664][m",...a);if(!t.login||!t.login.success)throw new Error("\u4F7F\u7528\u8005\u672A\u767B\u5165");let l=r.del_mail_match;if(l.length<1)return{success:!1};await Promise.all([e.waitForResponse("https://mailbox.gamer.com.tw/ajax/inboxList.php"),e.goto("https://mailbox.gamer.com.tw/?l=1")]),i("\u6B63\u5728\u641C\u96C6\u7AD9\u5167\u4FE1... ");let n=b(await M(e),l).map(a=>a.id);for(;(await e.$$(".nextPage")).length>0&&n.length<1e4;)i(`\u5DF2\u641C\u96C6 ${n.length} \u5C01\u7B26\u5408\u689D\u4EF6\u7684\u7AD9\u5167\u4FE1`),await Promise.all([e.waitForResponse("https://mailbox.gamer.com.tw/ajax/inboxList.php"),e.click(".nextPage")]),n=[...n,...b(await M(e),l).map(a=>a.id)];i(`\u5DF2\u641C\u96C6 ${n.length} \u5C01\u7B26\u5408\u689D\u4EF6\u7684\u7AD9\u5167\u4FE1`);let g=await(await e.$("#delFrm input[name='csrfToken']")).getAttribute("value");for(let a=0;a<n.length;a+=100){i(`\u6B63\u5728\u522A\u9664\u7B2C ${a+1} \u5230 ${Math.min(a+100,n.length)} \u5C01\u7AD9\u5167\u4FE1...`);let c=await L(e,n.slice(a,a+100),g);c.code===0?i(`\u5DF2\u6210\u529F\u522A\u9664\u7B2C ${a+1} \u5230 ${Math.min(a+100,n.length)} \u5C01\u7AD9\u5167\u4FE1`):s(`\u522A\u9664\u7B2C ${a+1} \u5230 ${Math.min(a+100,n.length)} \u5C01\u7AD9\u5167\u4FE1\u5931\u6557 (${c.code})`)}return{success:!0,deleted:n.length}};async function M(e){let t=[],r=await e.$$(".readR, .readU");for(let o of r){let i=(await(await o.$(".ML-tb1B")).textContent()).trim(),m=(await(await o.$(".mailTitle")).textContent()).trim(),s=new Date((await(await o.$("[nowrap='nowrap']")).textContent()).trim()),l=await o.$("input[type='checkbox']"),n=await l.getAttribute("value");t.push({id:n,sender:i,title:m,time:s,checkbox:l})}return t}function b(e,t){let r=[];for(let o of e){let{sender:i,title:m,time:s}=o;for(let l of t){let n=!0,{title:g,sender:a,before:c,after:p}=l;if(g&&!m.includes(g)&&(n=!1),a&&!i.includes(a)&&(n=!1),c&&s.getTime()>new Date(c).getTime()&&(n=!1),p&&s.getTime()<new Date(p).getTime()&&(n=!1),n){r.push(o);break}}}return r}async function L(e,t,r){return e.evaluate(async({mails:o,csrf:i})=>await(await fetch("https://mailbox.gamer.com.tw/ajax/inboxDel.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:`csrfToken=${i}${o.map(s=>`&del%5B%5D=${s}`).join("")}`})).json(),{mails:t,csrf:r})}var E=d;module.exports=T(k);0&&(module.exports={});
