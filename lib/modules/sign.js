/* minified */
"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const countapi_js_1=__importDefault(require("countapi-js")),_module_1=require("./_module"),sign=new _module_1.Module;async function sign_status(t){var t=(await t.evaluate(async()=>{const t=new AbortController;setTimeout(()=>t.abort(),3e4);const a=await fetch("https://www.gamer.com.tw/ajax/signin.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"action=2",signal:t.signal});return a.json()}))["data"];return t}function report({days:t,signed:a,doubled:i}){let e=`# 簽到

`;return e+=`✨✨✨ 已連續簽到 ${t} 天 ✨✨✨
`,e+=a?`🟢 今日已簽到
`:`❌ 今日尚未簽到
`,e+=i?`🟢 已獲得雙倍簽到獎勵
`:`❌ 尚未獲得雙倍簽到獎勵
`,e+="\n",e}sign.parameters=[{name:"sign_double_max_attempts",required:!1}],sign.run=async({page:t,outputs:i,params:a,logger:e})=>{var r=(...t)=>e.log("[95m[簽到][m",...t),o=(...t)=>e.error("[95m[簽到][m",...t);if(!i.login||!i.login.success)throw new Error("使用者未登入，無法簽到");r("開始執行"),await t.goto("https://www.gamer.com.tw/"),await t.waitForTimeout(2e3);let{days:n,finishedAd:s,signin:u}=await sign_status(t);var m=u;if(r("已連續簽到天數: "+n),u?r("今日已簽到 [92m✔[m"):(r("今日尚未簽到 [91m✘[m"),r("正在嘗試簽到"),await t.click("a#signin-btn").catch(o),await t.waitForTimeout(5e3),r("成功簽到 [92m✔[m")),i.ad_handler){var w=+a.sign_double_max_attempts||3;for(let a=0;a<w;a++)try{if(r("正在檢測雙倍簽到獎勵狀態"),await t.goto("https://www.gamer.com.tw/"),await t.waitForSelector("a#signin-btn"),await t.waitForTimeout(100),await t.click("a#signin-btn"),await t.waitForSelector("a.popoup-ctrl-btn"),await t.waitForTimeout(100),s){r("已獲得雙倍簽到獎勵 [92m✔[m");break}{r("尚未獲得雙倍簽到獎勵 [91m✘[m"),r("嘗試觀看廣告以獲得雙倍獎勵，可能需要多達 1 分鐘"),await t.click("a.popoup-ctrl-btn"),await t.waitForSelector("button[type=submit]"),await t.waitForTimeout(100),await t.click("button[type=submit]"),await t.waitForTimeout(3e3),await t.waitForSelector("ins iframe");const c=await t.$("ins iframe");var l=await c.contentFrame();if(await i.ad_handler({ad_frame:l}),s=(await sign_status(t)).finishedAd,s){r("已觀看雙倍獎勵廣告 [92m✔[m");break}throw new Error("觀看雙倍獎勵廣告過程發生未知錯誤")}}catch(t){o(t),o(`觀看雙倍獎勵廣告過程發生錯誤，將再重試 ${w-a-1} 次 [91m✘[m`)}}else e.warn("[95m[簽到][m","雙倍簽到獎勵需使用 ad_handler 模組");a=await sign_status(t);return r("執行完畢 ✨"),!m&&a.signin&&countapi_js_1.default.update("Bahamut-Automation","sign",1),{signed:!!a.signin,doubled:!!a.finishedAd,days:a.days,report:report}},exports.default=sign;