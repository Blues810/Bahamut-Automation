/* minified */
"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const _module_1=__importDefault(require("../_module")),ad_handler_module=new _module_1.default;let _log=()=>{},_error=()=>{};async function ad_handler({ad_frame:e,timeout:t=60,log:o=_log,error:a=_error}){o("Google AD 處理程式: Start"),o("timed out"===await Promise.race([sleep(1e3*t,"timed out"),(async()=>{try{if(await e.waitForTimeout(1e3),await e.$(".rewardDialogueWrapper:not([style*=none]) .rewardResumebutton")&&await e.click(".rewardDialogueWrapper:not([style*=none]) .rewardResumebutton"),await Promise.race([e.waitForSelector(".videoAdUiSkipContainer.html5-stop-propagation > button",{timeout:35e3}),checkTopRightClose(e),checkVideoEnded(e)]).catch(()=>{}),await e.waitForTimeout(1e3),await e.$(".videoAdUiSkipContainer.html5-stop-propagation > button"))await e.click(".videoAdUiSkipContainer.html5-stop-propagation > button");else if(await e.$("div#close_button_icon"))await e.click("div#close_button_icon");else if(await e.$("#google-rewarded-video > img:nth-child(4)"))await e.click("#google-rewarded-video > img:nth-child(4)");else if(!await checkVideoEnded(e))throw new Error("發現未知類型的廣告");await e.waitForTimeout(2e3)}catch(e){a(e)}})()])?"Google AD 處理程式: Timed Out":"Google AD 處理程式: Finished")}async function checkVideoEnded(e){const t=await e.waitForSelector("video");return!!await t.evaluate(e=>e.ended)||t.evaluate(t=>new Promise(e=>t.addEventListener("ended",()=>e(!0))))}function checkTopRightClose(a){return new Promise(async t=>{try{const o=await a.$("#count_down");var e;o?(e=+(await o.evaluate(e=>e.innerText)).replace(/[^0-9]/g,""),setTimeout(t,1e3*(1+e))):setTimeout(t,35e3)}catch(e){setTimeout(t,35e3)}})}function sleep(t=1e3,o){return new Promise(e=>setTimeout(()=>e(o),t))}ad_handler_module.run=async function({logger:t}){return _log=(...e)=>t.log("[95m[AD Handler][m",...e),_error=(...e)=>t.error("[95m[AD Handler][m",...e),_log("已設定 Google AD 處理程式"),ad_handler},exports.default=ad_handler_module;