/* minified */
const fetch=require("node-fetch"),countapi=require("countapi-js");function report({reward:e,answered:t}){let a="# 動畫瘋答題\n\n";return e&&(a+=`✨✨✨ 獲得 ${e} 巴幣 ✨✨✨
`),a+=t?`🟢 今日已答題
`:`❌ 今日尚未答題
`,a+="\n",a}exports.parameters=[{name:"answer_max_attempts",required:!1}],exports.run=async({page:t,outputs:e,params:a,logger:o})=>{var n=(...e)=>o.log("[95m[動畫瘋答題][m",...e);if(!e.login||!e.login.success)throw new Error("使用者未登入，無法答題");let r=0,s={};n("開始執行");var m=+a.answer_max_attempts||3;for(let e=0;e<m;e++)try{if(n("正在檢測答題狀態"),await t.goto("https://ani.gamer.com.tw/"),await t.waitForTimeout(200),s=await t.evaluate(()=>fetch("/ajax/animeGetQuestion.php?t="+Date.now()).then(e=>e.json())),s.question){const h=[null,s.a1,s.a2,s.a3,s.a4];n("尚未回答今日題目，嘗試答題中"),n("今天的問題："+s.question),n("選項："+h.filter(Boolean).join(", ")),n("正在尋找答案");var i=s.token,c=await fetch("https://api.gamer.com.tw/mobile_app/bahamut/v1/home.php?owner=blackXblue&page=1").then(e=>e.json()).then(e=>e.creation[0].sn),p=await fetch("https://api.gamer.com.tw/mobile_app/bahamut/v1/home_creation_detail.php?sn="+c).then(e=>e.json()).then(e=>e.content.match(/<body[\s\w"-=]*>([\s\S]*)<\/body>/)[0].match(/A[:：](\d)/gi)[0].match(/\d/)[0]).then(parseInt);n(`答案是 ${p}. ${h[p]} ！`),n("正在嘗試回答");let e=await t.evaluate(({ans:e,token:t})=>fetch("/ajax/animeAnsQuestion.php",{headers:{accept:"*/*","content-type":"application/x-www-form-urlencoded","sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin"},method:"POST",body:encodeURI(`token=${t}&ans=${e}&t=`+Date.now())}).then(e=>e.json()),{ans:p,token:i});e.error&&n("回答問題時發生錯誤 "+e.msg+" [91m✘[m"),e.ok&&(n("已回答問題 "+e.gift+" [92m✔[m"),r=+e.gift.match(/\d{2,4}/)[0])}else 1===s.error&&"今日已經答過題目了，一天僅限一次機會"===s.msg?n("今日已經答過題目了 [92m✔[m"):n("發生未知錯誤："+s.msg+" [91m✘[m");await t.waitForTimeout(1e3);break}catch(e){o.error(e),n("發生錯誤，重試中 [91m✘[m")}return n("執行完畢 ✨"),r&&countapi.update("Bahamut-Automation","answer",r),{answered:!(1!==s.error&&!r),reward:r,report:report}};