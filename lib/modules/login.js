/* minified */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const otplib_1=require("otplib"),_module_1=require("./_module"),login=new _module_1.Module;async function check2FA(t,a,e,o){if(await t.$("[name=twoStepAuth][required]")){if(o("有啟用 2FA"),!a.twofa)throw new Error("未提供 2FA 種子碼");a=otplib_1.authenticator.generate(a.twofa);await t.type("[name=twoStepAuth]",a,{delay:10}).catch(e)}else o("沒有啟用 2FA")}login.parameters=[{name:"username",required:!0},{name:"password",required:!0},{name:"twofa",required:!1},{name:"login_max_attempts",required:!1}],login.run=async({page:a,params:e,logger:o})=>{var r=(...t)=>o.log("[95m[登入][m",...t),i=(...t)=>o.error("[95m[登入][m",...t);let w=!1;r("開始執行帳號登入程序"),await a.goto("https://www.gamer.com.tw/").catch(i),await a.waitForTimeout(1e3);var c=+e.login_max_attempts||3;for(let t=0;t<c;t++)try{if(r("正在檢測登入狀態"),await a.goto("https://www.gamer.com.tw/"),await a.waitForSelector("#topBar_more"),await a.waitForTimeout(100),!await a.$("div.TOP-my.TOP-nologin")){r("登入狀態: 已登入"),w=!0;break}if(r("登入狀態: 未登入"),await a.goto("https://user.gamer.com.tw/login.php").catch(i),r("嘗試登入中"),!e.username||!e.password)throw new Error("帳號或密碼不能為空");await a.$eval("input.form-control[type=text]",t=>t.value="").catch(i),await a.$eval("input.form-control[type=password]",t=>t.value="").catch(i),await a.type("input.form-control[type=text]",e.username,{delay:101}).catch(i),await a.waitForTimeout(500),await a.type("input.form-control[type=password]",e.password,{delay:101}).catch(i),await a.waitForTimeout(1e3),await check2FA(a,e,i,r),await a.waitForTimeout(500),await a.click("a#btn-login").catch(i),await a.waitForTimeout(3e3),0<t&&r("已嘗試登入，重新檢測登入狀態")}catch(t){i(t),i("登入時發生錯誤，重新嘗試中")}return r("帳號登入程序已完成"),{success:w}},exports.default=login;