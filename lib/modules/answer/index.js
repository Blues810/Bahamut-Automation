/* minified */
"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const node_fetch_1=__importDefault(require("node-fetch")),countapi_js_1=__importDefault(require("countapi-js")),_module_1=__importDefault(require("../_module")),answer=new _module_1.default;function report({reward:e,answered:t}){let a="# 動畫瘋答題\n\n";return e&&(a+=`✨✨✨ 獲得 ${e} 巴幣 ✨✨✨
`),a+=t?`🟢 今日已答題
`:`❌ 今日尚未答題
`,a+="\n",a}answer.parameters=[{name:"answer_max_attempts",required:!1}],answer.run=async({page:t,outputs:e,params:a,logger:o})=>{var r=(...e)=>o.log("[95m[動畫瘋答題][m",...e);if(!e.login||!e.login.success)throw new Error("使用者未登入，無法答題");let n=0,s={};r("開始執行");var i=+a.answer_max_attempts||3;for(let e=0;e<i;e++)try{if(r("正在檢測答題狀態"),await t.goto("https://ani.gamer.com.tw/"),await t.waitForTimeout(200),s=await t.evaluate(()=>(0,node_fetch_1.default)("/ajax/animeGetQuestion.php?t="+Date.now()).then(e=>e.json())),s.question){const p=[null,s.a1,s.a2,s.a3,s.a4];r("尚未回答今日題目，嘗試答題中"),r("今天的問題："+s.question),r("選項："+p.filter(Boolean).join(", ")),r("正在尋找答案");var m=s.token,u=await(0,node_fetch_1.default)("https://api.gamer.com.tw/mobile_app/bahamut/v1/home.php?owner=blackXblue&page=1").then(e=>e.json()).then(e=>e.creation[0].sn),c=await(0,node_fetch_1.default)("https://api.gamer.com.tw/mobile_app/bahamut/v1/home_creation_detail.php?sn="+u).then(e=>e.json()).then(e=>e.content.match(/<body[\s\w"-=]*>([\s\S]*)<\/body>/)[0].match(/A[:：](\d)/gi)[0].match(/\d/)[0]).then(parseInt);r(`答案是 ${c}. ${p[c]} ！`),r("正在嘗試回答");let e=await t.evaluate(async({ans:e,token:t})=>{const a=await(0,node_fetch_1.default)("/ajax/animeAnsQuestion.php",{headers:{accept:"*/*","content-type":"application/x-www-form-urlencoded","sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin"},method:"POST",body:encodeURI(`token=${t}&ans=${e}&t=`+Date.now())});return a.json()},{ans:c,token:m});e.error&&r("回答問題時發生錯誤 "+e.msg+" [91m✘[m"),e.ok&&(r("已回答問題 "+e.gift+" [92m✔[m"),n=+e.gift.match(/\d{2,4}/)[0])}else 1===s.error&&"今日已經答過題目了，一天僅限一次機會"===s.msg?r("今日已經答過題目了 [92m✔[m"):r("發生未知錯誤："+s.msg+" [91m✘[m");await t.waitForTimeout(1e3);break}catch(e){o.error(e),r("發生錯誤，重試中 [91m✘[m")}return r("執行完畢 ✨"),n&&countapi_js_1.default.update("Bahamut-Automation","answer",n),{answered:!(1!==s.error&&!n),reward:n,report:report}},exports.default=answer;