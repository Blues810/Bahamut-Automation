var S=Object.create;var f=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var B=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var _=a=>f(a,"__esModule",{value:!0});var C=(a,t)=>{for(var i in t)f(a,i,{get:t[i],enumerable:!0})},L=(a,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of q(t))!j.call(a,e)&&(i||e!=="default")&&f(a,e,{get:()=>t[e],enumerable:!(o=A(t,e))||o.enumerable});return a},O=(a,t)=>L(_(f(a!=null?S(B(a)):{},"default",!t&&a&&a.__esModule?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a),R=(a=>(t,i)=>a&&a.get(t)||(i=L(_({}),t,1),a&&a.set(t,i),i))(typeof WeakMap!="undefined"?new WeakMap:0);var K={};C(K,{default:()=>J});var P=O(require("countapi-js"));var T=class{parameters=[];run({page:t,outputs:i,params:o,logger:e}){throw new Error("Module not implemented.")}};var k=class{size;tasks=[];results=[];available;resolves=[];constructor(t){this.size=t,this.available=t}push(t){this.tasks.push(async()=>t())}async go(){let t=[];for(let i=0;i<this.tasks.length;i++)await this.isAvailable(),t.push(this.tasks[i]().then(o=>{this.results[i]=o,this.resolves.length>0&&this.resolves.shift()(!1)}));return await Promise.all(t),this.results}isAvailable(){return new Promise(t=>{this.available>0?(this.available--,t(!0)):this.resolves.push(t)})}},H=k;var M=new T;M.parameters=[{name:"lottery_max_attempts",required:!1},{name:"lottery_max_parallel",required:!1}];M.run=async({page:a,outputs:t,params:i,logger:o})=>{let e=(...m)=>o.log("\x1B[95m[\u798F\u5229\u793E]\x1B[m",...m),r=(...m)=>o.error("\x1B[95m[\u798F\u5229\u793E]\x1B[m",...m);if(!t.utils.logged_in())throw new Error("\u4F7F\u7528\u8005\u672A\u767B\u5165\uFF0C\u7121\u6CD5\u62BD\u734E");if(!t.ad_handler)throw new Error("\u9700\u4F7F\u7528 ad_handler \u6A21\u7D44");e("\u958B\u59CB\u57F7\u884C");let s=0;e("\u6B63\u5728\u5C0B\u627E\u62BD\u62BD\u6A02");let c=await z(a,r);e(`\u627E\u5230 ${c.length} \u500B\u62BD\u62BD\u6A02`);let l={};c.forEach(({name:m,link:y},g)=>{e(`${g+1}: ${m}`),l[m]=y});let E=+i.lottery_max_parallel||1,I=+i.lottery_max_attempts||20,F=a.context(),$=new H(E);for(let m=0;m<c.length;m++)$.push(async()=>{let y=m,{link:g,name:h}=c[y],n=await F.newPage();for(let p=1;p<=I;p++)try{if(await n.goto(g),await n.waitForSelector("#BH-master > .BH-lbox.fuli-pbox h1"),await n.waitForTimeout(100),await n.$(".btn-base.c-accent-o.is-disable")){e(`${h} \u7684\u5EE3\u544A\u514D\u8CBB\u6B21\u6578\u5DF2\u7528\u5B8C \x1B[92m\u2714\x1B[m`),delete l[h];break}e(`[${y+1} / ${c.length}] (${p}) ${h}`),await Promise.all([n.waitForResponse(/ajax\/check_ad.php/,{timeout:5e3}),n.click("text=\u770B\u5EE3\u544A\u514D\u8CBB\u514C\u63DB").catch(r)]),await n.$eval(".dialogify",u=>u.innerText.includes("\u52C7\u8005\u554F\u7B54\u8003\u9A57")).catch(()=>{})&&(e("\u9700\u8981\u56DE\u7B54\u554F\u984C\uFF0C\u6B63\u5728\u56DE\u7B54\u554F\u984C"),await n.$$eval("#dialogify_1 .dialogify__body a",u=>{u.forEach(d=>{d.dataset.option==d.dataset.answer&&d.click()})}),await n.waitForSelector("#btn-buy"),await n.waitForTimeout(100),await n.click("#btn-buy")),await Promise.all([n.waitForResponse(/file\.(mp4|webm)/,{timeout:5e3}).catch(()=>{}),n.waitForSelector(".dialogify .dialogify__body p",{timeout:5e3}).catch(()=>{})]);let w=await n.$eval(".dialogify .dialogify__body p",u=>u.innerText).catch(()=>{})||"",x;if(w.includes("\u5EE3\u544A\u80FD\u91CF\u88DC\u5145\u4E2D")){r("\u5EE3\u544A\u80FD\u91CF\u88DC\u5145\u4E2D"),await n.reload().catch(r);continue}else if(w.includes("\u89C0\u770B\u5EE3\u544A")){e("\u6B63\u5728\u89C0\u770B\u5EE3\u544A"),await n.click("text=\u78BA\u5B9A"),await n.waitForSelector("ins iframe").catch(r),await n.waitForTimeout(1e3);let u=await n.$("ins iframe").catch(r);try{x=await u.contentFrame(),await t.ad_handler({ad_frame:x})}catch(d){r(d)}await n.waitForTimeout(1e3)}else w&&e(w);let b=n.url();b.includes("/buyD.php")&&b.includes("ad=1")?(e("\u6B63\u5728\u78BA\u8A8D\u7D50\u7B97\u9801\u9762"),await D(n,e,r).catch(r),await N(n,r).catch(r),await n.$(".card > .section > p")&&await n.$eval(".card > .section > p",u=>u.innerText.includes("\u6210\u529F"))?(e("\u5DF2\u5B8C\u6210\u4E00\u6B21\u62BD\u62BD\u6A02\uFF1A"+h+" \x1B[92m\u2714\x1B[m"),s++):e("\u767C\u751F\u932F\u8AA4\uFF0C\u91CD\u8A66\u4E2D \x1B[91m\u2718\x1B[m")):(e(b),e("\u672A\u9032\u5165\u7D50\u7B97\u9801\u9762\uFF0C\u91CD\u8A66\u4E2D \x1B[91m\u2718\x1B[m"),r("\u62BD\u62BD\u6A02\u672A\u9032\u5165\u7D50\u7B97\u9801\u9762"))}catch(w){r("!",w)}await n.close()});return await $.go(),await a.waitForTimeout(2e3),e("\u57F7\u884C\u5B8C\u7562 \u2728"),s&&P.default.update("Bahamut-Automation","lottery",s),{lottery:s,unfinished:l,report:G}};async function z(a,t){let i,o=3;for(;o-- >0;){i=[];try{await a.goto("https://fuli.gamer.com.tw/shop.php?page=1");let e=await a.$$("a.items-card");for(let r=e.length-1;r>=0;r--)await e[r].evaluate(c=>c.innerHTML.includes("\u62BD\u62BD\u6A02"))&&i.push({name:await e[r].evaluate(c=>c.querySelector(".items-title").innerHTML),link:await e[r].evaluate(c=>c.href)});for(;await a.$eval("a.pagenow",r=>!!r.nextSibling);){await a.goto("https://fuli.gamer.com.tw/shop.php?page="+await a.$eval("a.pagenow",s=>s.nextSibling.innerText));let r=await a.$$("a.items-card");for(let s=r.length-1;s>=0;s--)await r[s].evaluate(l=>l.innerHTML.includes("\u62BD\u62BD\u6A02"))&&i.push({name:await r[s].evaluate(l=>l.querySelector(".items-title").innerHTML),link:await r[s].evaluate(l=>l.href)})}break}catch(e){t(e)}}return i}async function D(a,t,i){try{let o=await a.$eval("#name",l=>l.value),e=await a.$eval("#tel",l=>l.value),r=await a.$eval("[name=city]",l=>l.value),s=await a.$eval("[name=country]",l=>l.value),c=await a.$eval("#address",l=>l.value);if(o||t("\u7121\u6536\u4EF6\u4EBA\u59D3\u540D"),e||t("\u7121\u6536\u4EF6\u4EBA\u96FB\u8A71"),r||t("\u7121\u6536\u4EF6\u4EBA\u57CE\u5E02"),s||t("\u7121\u6536\u4EF6\u4EBA\u5340\u57DF"),c||t("\u7121\u6536\u4EF6\u4EBA\u5730\u5740"),!o||!e||!r||!s||!c)throw new Error("\u8B66\u544A\uFF1A\u6536\u4EF6\u4EBA\u8CC7\u6599\u4E0D\u5168")}catch(o){i(o)}}async function N(a,t){try{await a.waitForSelector("input[name='agreeConfirm']"),await(await a.$("input[name='agreeConfirm']")).getAttribute("checked")===null&&await a.check("input[name='agreeConfirm']"),await a.waitForTimeout(100),await a.waitForSelector("a:has-text('\u78BA\u8A8D\u514C\u63DB')"),await a.waitForTimeout(100),await a.click("a:has-text('\u78BA\u8A8D\u514C\u63DB')"),await a.waitForSelector("button:has-text('\u78BA\u5B9A')"),await a.waitForTimeout(100),await Promise.all([a.waitForNavigation(),a.click("button:has-text('\u78BA\u5B9A')")]),await a.waitForTimeout(300)}catch(i){t(a.url()),t(i)}}function G({lottery:a,unfinished:t}){let i=`# \u798F\u5229\u793E\u62BD\u62BD\u6A02 

`;return a&&(i+=`\u2728\u2728\u2728 \u7372\u5F97 **${a}** \u500B\u62BD\u734E\u6A5F\u6703\uFF0C\u50F9\u503C **${(a*500).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}** \u5DF4\u5E63 \u2728\u2728\u2728
`),Object.keys(t).length===0&&(i+=`\u{1F7E2} \u6240\u6709\u62BD\u734E\u7686\u5DF2\u5B8C\u6210
`),Object.keys(t).forEach(o=>{t[o]!==void 0&&(i+=`\u274C \u672A\u80FD\u81EA\u52D5\u5B8C\u6210\u6240\u6709 ***[${o}](${t[o]})*** \u7684\u62BD\u734E
`)}),i+=`
`,i}var J=M;module.exports=R(K);0&&(module.exports={});
