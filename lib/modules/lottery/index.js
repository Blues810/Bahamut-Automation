/* minified */
"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const countapi_js_1=__importDefault(require("countapi-js")),pool_1=__importDefault(require("./pool")),_module_1=require("../_module"),lottery=new _module_1.Module;async function getList(t,a){let e,i=3;for(;0<i--;){e=[];try{await t.goto("https://fuli.gamer.com.tw/shop.php?page=1");let a=await t.$$("a.items-card");for(let t=a.length-1;0<=t;t--)await a[t].evaluate(t=>t.innerHTML.includes("抽抽樂"))&&e.push({name:await a[t].evaluate(t=>t.querySelector(".items-title").innerHTML),link:await a[t].evaluate(t=>t.href)});for(;await t.$eval("a.pagenow",t=>!!t.nextSibling);){await t.goto("https://fuli.gamer.com.tw/shop.php?page="+await t.$eval("a.pagenow",t=>t.nextSibling.innerText));let a=await t.$$("a.items-card");for(let t=a.length-1;0<=t;t--)await a[t].evaluate(t=>t.innerHTML.includes("抽抽樂"))&&e.push({name:await a[t].evaluate(t=>t.querySelector(".items-title").innerHTML),link:await a[t].evaluate(t=>t.href)})}break}catch(t){a(t)}}return e}async function checkInfo(t,a,e){try{var i=await t.$eval("#name",t=>t.value),r=await t.$eval("#tel",t=>t.value),o=await t.$eval("[name=city]",t=>t.value),n=await t.$eval("[name=country]",t=>t.value),l=await t.$eval("#address",t=>t.value);if(i||a("無收件人姓名"),r||a("無收件人電話"),o||a("無收件人城市"),n||a("無收件人區域"),l||a("無收件人地址"),!(i&&r&&o&&n&&l))throw new Error("警告：收件人資料不全")}catch(t){e(t)}}async function confirm(a,e){try{await a.click("#agree-confirm"),await a.waitForSelector("#buyD > div.pbox-btn > a"),await a.waitForTimeout(100),await a.click("#buyD > div.pbox-btn > a"),await a.waitForSelector("#dialogify_1 > form > div > div > div.btn-box.text-right > button.btn.btn-insert.btn-primary"),await a.waitForTimeout(100),await Promise.all([a.waitForNavigation(),a.click("#dialogify_1 > form > div > div > div.btn-box.text-right > button.btn.btn-insert.btn-primary")]),await a.waitForTimeout(1e3)}catch(t){e(a.url()),e(t)}}function report({lottery:t,unfinished:a}){let e="# 福利社抽抽樂 \n\n";return t&&(e+=`✨✨✨ 獲得 **${t}** 個抽獎機會，價值 **${(500*t).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}** 巴幣 ✨✨✨
`),0===Object.keys(a).length&&(e+="🟢 所有抽獎皆已完成\n"),Object.keys(a).forEach(t=>{void 0!==a[t]&&(e+=`❌ 未能自動完成所有 ***[${t}](${a[t]})*** 的抽獎
`)}),e+="\n",e}lottery.parameters=[{name:"lottery_max_attempts",required:!1},{name:"lottery_max_parallel",required:!1}],lottery.run=async({page:t,outputs:u,params:a,logger:e})=>{const w=(...t)=>e.log("[95m[福利社][m",...t),s=(...t)=>e.error("[95m[福利社][m",...t);if(!u.login||!u.login.success)throw new Error("使用者未登入，無法抽獎");if(!u.ad_handler)throw new Error("需使用 ad_handler 模組");w("開始執行");let m=0;w("正在尋找抽抽樂");const d=await getList(t,s);w(`找到 ${d.length} 個抽抽樂`);const p={};d.forEach(({name:t,link:a},e)=>{w(e+1+": "+t),p[t]=a});var i=+a.lottery_max_parallel||1;const f=+a.lottery_max_attempts||20,h=t.context(),r=new pool_1.default(i);for(let t=0;t<d.length;t++)r.push(async()=>{var e,i=t,{link:r,name:o}=d[i];const n=await h.newPage();for(let a=1;a<=f;a++)try{if(await n.goto(r),await n.waitForSelector("#BH-master > .BH-lbox.fuli-pbox h1"),await n.waitForTimeout(100),await n.$(".btn-base.c-accent-o.is-disable")){w(o+" 的廣告免費次數已用完 [92m✔[m"),delete p[o];break}w(`[${i+1} / ${d.length}] (${a}) `+o),await n.click(".btn-base.c-accent-o").catch(s),await n.waitForTimeout(3e3),await n.$eval(".dialogify",t=>t.innerText.includes("勇者問答考驗")).catch(()=>{})&&(w("需要回答問題，正在回答問題"),await n.$$eval("#dialogify_1 .dialogify__body a",t=>{t.forEach(t=>{t.dataset.option==t.dataset.answer&&t.click()})}),await n.waitForSelector("#btn-buy"),await n.waitForTimeout(100),await n.click("#btn-buy")),await n.waitForTimeout(5e3);let t=await n.$eval(".dialogify .dialogify__body p",t=>t.innerText).catch(()=>{})||"";if(t.includes("廣告能量補充中")){await s("廣告能量補充中"),await n.reload().catch(s);continue}if(t.includes("觀看廣告")){w("正在觀看廣告"),await n.click("button[type=submit].btn.btn-insert.btn-primary").catch(s),await n.waitForSelector("ins iframe").catch(s),await n.waitForTimeout(1e3);const c=await n.$("ins iframe").catch(s);try{e=await c.contentFrame(),await u.ad_handler({ad_frame:e})}catch(t){s(t)}await n.waitForTimeout(1e3)}else w(t);const l=n.url();l.includes("/buyD.php")&&l.includes("ad=1")?(w("正在確認結算頁面"),await checkInfo(n,w,s).catch(s),await confirm(n,s).catch(s),await n.$(".card > .section > p")&&await n.$eval(".card > .section > p",t=>t.innerText.includes("成功"))?(w("已完成一次抽抽樂："+o+" [92m✔[m"),m++):w("發生錯誤，重試中 [91m✘[m")):(w(l),w("未進入結算頁面，重試中 [91m✘[m"),s("抽抽樂未進入結算頁面"))}catch(t){}});return await r.go(),await t.waitForTimeout(2e3),w("執行完畢 ✨"),m&&countapi_js_1.default.update("Bahamut-Automation","lottery",m),{lottery:m,unfinished:p,report:report}},exports.default=lottery;